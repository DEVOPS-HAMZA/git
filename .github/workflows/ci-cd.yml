name: CI/CD Pipeline

on:
  push:
    branches:
      - '*'
      - '!master'
      - '!release/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'prod'

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Lint Code
        run: echo "Running linters..."
      - name: Run Tests
        run: echo "Running tests..."

  build-and-push-image:
    needs: lint-and-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Build and push Docker image
        run: |
          echo "Building Docker image..."
          echo "Pushing Docker image to registry..."

  deploy-to-develop:
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    needs: build-and-push-image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Deploy to development environment
        run: echo "Deploying to development environment..."

  deploy-to-staging:
    if: startsWith(github.ref, 'refs/heads/release/') && github.event_name == 'push'
    needs: build-and-push-image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Deploy to staging environment
        run: |
          echo "Deploying to staging environment..."
          VERSION_TAG=${GITHUB_REF#refs/heads/release/}
          echo "Version tag is $VERSION_TAG"

  deploy-to-production:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Build Docker image for production
        run: echo "Building Docker image for prod..."
      - name: Push to Docker Registry
        run: echo "Pushing Docker image to registry for prod..."
      - name: Deploy to production environment
        run: echo "Deploying to production environment..."
